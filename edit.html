<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Your Profile</title>
    <script src="//unpkg.com/alpinejs" defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <style>
        [x-cloak] { display: none; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans">
    <!-- Loading Spinner -->
    <div x-show="loading" class="fixed inset-0 bg-gray-900 flex items-center justify-center">
        <div class="animate-spin rounded-full h-32 w-32 border-t-4 border-b-4 border-blue-400"></div>
    </div>

    <!-- Form Content -->
    <div x-show="!loading" x-cloak x-data="profileForm()" x-init="init()" class="container mx-auto px-4 py-8">
        <form @submit.prevent="submitForm" class="max-w-4xl mx-auto space-y-8">
            <!-- All form sections remain the same as original -->
            <!-- ... (keep all the existing form sections) ... -->


            <!-- Personal Information -->
            <div class="bg-gray-800 p-6 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-bold text-blue-400 mb-6 border-b-2 border-blue-400 pb-2">Personal Information</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block mb-2">Full Name</label>
                        <input type="text" x-model="formData.name" required 
                               class="w-full bg-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 outline-none">
                    </div>
                    <div>
                        <label class="block mb-2">Job Title</label>
                        <input type="text" x-model="formData.jobTitle" required 
                               class="w-full bg-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 outline-none">
                    </div>
                    <div>
                        <label class="block mb-2">Photo URL</label>
                        <input type="url" x-model="formData.photoURL" 
                               class="w-full bg-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 outline-none">
                    </div>
                    <div>
                        <label class="block mb-2">Date of Birth</label>
                        <input type="date" x-model="formData.dob" 
                               class="w-full bg-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 outline-none">
                    </div>
                    <div>
                        <label class="block mb-2">Location</label>
                        <input type="text" x-model="formData.location" 
                               class="w-full bg-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 outline-none">
                    </div>
                    <div>
                        <label class="block mb-2">Bio</label>
                        <input type="text" x-model="formData.bio" 
                               class="w-full bg-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 outline-none">
                    </div>
                </div>
            </div>

            <!-- About Section -->
            <div class="bg-gray-800 p-6 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-bold text-blue-400 mb-6 border-b-2 border-blue-400 pb-2">About</h2>
                <textarea x-model="formData.about" 
                          class="w-full bg-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 outline-none h-32"
                          placeholder="Write about yourself..."></textarea>
            </div>

            <!-- Skills Section -->
            <div class="bg-gray-800 p-6 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-bold text-blue-400 mb-6 border-b-2 border-blue-400 pb-2">Skills</h2>
                <template x-for="(skill, index) in formData.skills" :key="index">
                    <div class="flex gap-4 mb-4">
                        <input type="text" x-model="skill.name" placeholder="Skill name"
                               class="w-full bg-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 outline-none">
                        <input type="number" x-model="skill.level" min="0" max="100" 
                               class="w-24 bg-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 outline-none"
                               placeholder="Level">
                        <button type="button" @click="removeSkill(index)" 
                                class="text-red-400 hover:text-red-300">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </template>
                <button type="button" @click="addSkill" 
                        class="mt-4 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors">
                    Add Skill
                </button>
            </div>

            <!-- Education Section -->
            <div class="bg-gray-800 p-6 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-bold text-blue-400 mb-6 border-b-2 border-blue-400 pb-2">Education</h2>
                <template x-for="(edu, index) in formData.education" :key="index">
                    <div class="mb-6 space-y-4">
                        <div class="grid md:grid-cols-3 gap-4">
                            <input type="text" x-model="edu.institution" placeholder="Institution"
                                   class="bg-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 outline-none">
                            <input type="text" x-model="edu.degree" placeholder="Degree"
                                   class="bg-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 outline-none">
                            <input type="text" x-model="edu.duration" placeholder="Duration (e.g., 2015-2019)"
                                   class="bg-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 outline-none">
                        </div>
                        <button type="button" @click="removeEducation(index)" 
                                class="text-red-400 hover:text-red-300">
                            Remove Education
                        </button>
                    </div>
                </template>
                <button type="button" @click="addEducation" 
                        class="mt-4 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors">
                    Add Education
                </button>
            </div>

            <!-- Experience Section -->
            <div class="bg-gray-800 p-6 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-bold text-blue-400 mb-6 border-b-2 border-blue-400 pb-2">Experience</h2>
                <template x-for="(exp, index) in formData.experience" :key="index">
                    <div class="mb-6 space-y-4">
                        <div class="grid md:grid-cols-3 gap-4">
                            <input type="text" x-model="exp.company" placeholder="Company"
                                   class="bg-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 outline-none">
                            <input type="text" x-model="exp.position" placeholder="Position"
                                   class="bg-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 outline-none">
                            <input type="text" x-model="exp.duration" placeholder="Duration (e.g., 2022-Present)"
                                   class="bg-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 outline-none">
                        </div>
                        <div class="space-y-2">
                            <template x-for="(desc, descIndex) in exp.description" :key="descIndex">
                                <div class="flex gap-2">
                                    <input type="text" x-model="exp.description[descIndex]" placeholder="Description point"
                                           class="w-full bg-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 outline-none">
                                    <button type="button" @click="removeExperienceDescription(index, descIndex)"
                                            class="text-red-400 hover:text-red-300">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </template>
                            <button type="button" @click="addExperienceDescription(index)"
                                    class="text-blue-400 hover:text-blue-300 text-sm">
                                + Add Description Point
                            </button>
                        </div>
                        <button type="button" @click="removeExperience(index)" 
                                class="text-red-400 hover:text-red-300">
                            Remove Experience
                        </button>
                    </div>
                </template>
                <button type="button" @click="addExperience" 
                        class="mt-4 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors">
                    Add Experience
                </button>
            </div>

            <!-- Projects Section -->
            <div class="bg-gray-800 p-6 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-bold text-blue-400 mb-6 border-b-2 border-blue-400 pb-2">Projects</h2>
                <template x-for="(project, index) in formData.projects" :key="index">
                    <div class="mb-6 space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <input type="text" x-model="project.title" placeholder="Title"
                                   class="bg-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 outline-none">
                            <input type="text" x-model="project.role" placeholder="Role"
                                   class="bg-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 outline-none">
                        </div>
                        <textarea x-model="project.description" placeholder="Project description"
                                  class="w-full bg-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 outline-none h-24"></textarea>
                        <div class="space-y-2">
                            <template x-for="(tech, techIndex) in project.technologies" :key="techIndex">
                                <div class="flex gap-2">
                                    <input type="text" x-model="project.technologies[techIndex]" placeholder="Technology"
                                           class="w-full bg-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 outline-none">
                                    <button type="button" @click="removeProjectTechnology(index, techIndex)"
                                            class="text-red-400 hover:text-red-300">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </template>
                            <button type="button" @click="addProjectTechnology(index)"
                                    class="text-blue-400 hover:text-blue-300 text-sm">
                                + Add Technology
                            </button>
                        </div>
                        <input type="url" x-model="project.url" placeholder="Project URL"
                               class="w-full bg-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 outline-none">
                        <button type="button" @click="removeProject(index)" 
                                class="text-red-400 hover:text-red-300">
                            Remove Project
                        </button>
                    </div>
                </template>
                <button type="button" @click="addProject" 
                        class="mt-4 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors">
                    Add Project
                </button>
            </div>

            <!-- Social Links -->
            <div class="bg-gray-800 p-6 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-bold text-blue-400 mb-6 border-b-2 border-blue-400 pb-2">Social Links</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="flex items-center gap-3">
                        <i class="fab fa-facebook text-blue-400 text-xl"></i>
                        <input type="url" x-model="formData.socials.facebook" placeholder="Facebook URL"
                               class="w-full bg-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 outline-none">
                    </div>
                    <div class="flex items-center gap-3">
                        <i class="fab fa-instagram text-blue-400 text-xl"></i>
                        <input type="url" x-model="formData.socials.instagram" placeholder="Instagram URL"
                               class="w-full bg-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 outline-none">
                    </div>
                    <div class="flex items-center gap-3">
                        <i class="fab fa-telegram text-blue-400 text-xl"></i>
                        <input type="url" x-model="formData.socials.telegram" placeholder="Telegram URL"
                               class="w-full bg-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 outline-none">
                    </div>
                    <div class="flex items-center gap-3">
                        <i class="fab fa-github text-blue-400 text-xl"></i>
                        <input type="url" x-model="formData.socials.github" placeholder="GitHub URL"
                               class="w-full bg-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 outline-none">
                    </div>
                    <div class="flex items-center gap-3">
                        <i class="fab fa-linkedin text-blue-400 text-xl"></i>
                        <input type="url" x-model="formData.socials.linkedin" placeholder="LinkedIn URL"
                               class="w-full bg-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 outline-none">
                    </div>
                </div>
            </div>







            <!-- Submit Button -->
            <div class="text-center">
                <button type="submit" :disabled="submitting"
                        class="px-8 py-3 bg-blue-600 hover:bg-blue-700 rounded-xl text-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    <span x-show="!submitting">Create Profile</span>
                    <span x-show="submitting" class="flex items-center gap-2">
                        <i class="fas fa-spinner fa-spin"></i>
                        Saving...
                    </span>
                </button>
            </div>
        </form>
    </div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyA7iRhlrgnn44g-NiDJCNTjIZpa0Xt7mY0",
    authDomain: "flask-chat-9e635.firebaseapp.com",
    projectId: "flask-chat-9e635",
    storageBucket: "flask-chat-9e635.appspot.com",
    messagingSenderId: "594505769024",
    appId: "1:594505769024:web:280db3b1e516f581ea7fa5",
    measurementId: "G-YL8QV4KWW5"
};

const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

function profileForm() {
    return {
        loading: true,
        submitting: false,
        uid: null,
        formData: {
            name: '',
            jobTitle: '',
            photoURL: '',
            bio: '',
            dob: '',
            location: '',
            about: '',
            skills: [],
            education: [],
            experience: [],
            projects: [],
            socials: {
                facebook: '',
                instagram: '',
                telegram: '',
                github: '',
                linkedin: ''
            }
        },

        getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        },

        async init() {
            try {
                const uidFromURL = this.getQueryParam('uid');
                const user = await new Promise((resolve, reject) => {
                    const unsubscribe = auth.onAuthStateChanged(user => {
                        unsubscribe();
                        resolve(user);
                    }, reject);
                });

                // Authentication check
                if (!user) {
                    window.location.href = '/index.html';
                    return;
                }

                // Authorization check
                if (uidFromURL && uidFromURL !== user.uid) {
                    window.location.href = window.location.pathname;
                    return;
                }

                this.uid = user.uid;

                // Profile existence check
                const doc = await db.collection('profiles').doc(this.uid).get();
                if (doc.exists) {
                    window.location.href = `/profile.html?uid=${this.uid}`;
                    return;
                }
            } catch (error) {
                console.error('Initialization error:', error);
                alert('Error initializing: ' + error.message);
            } finally {
                this.loading = false;
            }
        },

        async submitForm() {
            try {
                this.submitting = true;
                
                // Additional validation
                if (!this.formData.name.trim() || !this.formData.jobTitle.trim()) {
                    throw new Error('Name and Job Title are required');
                }

                const profileData = {
                    ...this.formData,
                    uid: this.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('profiles').doc(this.uid).set(profileData);
                window.location.href = `/profile.html?uid=${this.uid}`;
            } catch (error) {
                console.error('Submission error:', error);
                alert('Error saving profile: ' + error.message);
            } finally {
                this.submitting = false;
            }
        },

        // Keep all the existing methods for handling arrays
        //addSkill() { /* ... */ },
        //removeSkill(index) { /* ... */ },
        // ... (keep all existing array management methods)
    };
}
</script>
</body>
</html>